/*! For license information please see ohif-extension-cornerstone-dicom-sr.umd.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@ohif/core"),require("gl-matrix"),require("@cornerstonejs/tools"),require("@cornerstonejs/core"),require("@cornerstonejs/adapters"),require("dcmjs"),require("@ohif/ui")):"function"==typeof define&&define.amd?define(["@ohif/core","gl-matrix","@cornerstonejs/tools","@cornerstonejs/core","@cornerstonejs/adapters","dcmjs","@ohif/ui"],t):"object"==typeof exports?exports["ohif-extension-cornerstone-dicom-sr"]=t(require("@ohif/core"),require("gl-matrix"),require("@cornerstonejs/tools"),require("@cornerstonejs/core"),require("@cornerstonejs/adapters"),require("dcmjs"),require("@ohif/ui")):e["ohif-extension-cornerstone-dicom-sr"]=t(e["@ohif/core"],e["gl-matrix"],e["@cornerstonejs/tools"],e["@cornerstonejs/core"],e["@cornerstonejs/adapters"],e.dcmjs,e["@ohif/ui"])}(globalThis,((e,t,n,r,o,a,i)=>(()=>{var s,c,l={365:(e,t,n)=>{"use strict";n.d(t,{l2:()=>a,yR:()=>i});var r=n(464);const o={TrackingUniqueIdentifier:null,trackingIdentifiersByViewportId:{}};function a(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const a=(0,r.getEnabledElement)(e),{viewport:i}=a;o.trackingIdentifiersByViewportId[i.id]={trackingUniqueIdentifiers:t,activeIndex:n}}function i(e){const t=(0,r.getEnabledElement)(e),{viewport:n}=t;return o.trackingIdentifiersByViewportId[n.id]?o.trackingIdentifiersByViewportId[n.id]:{trackingUniqueIdentifiers:[]}}},414:(e,t,n)=>{"use strict";n.d(t,{Z:()=>m});var r=n(464),o=n(762),a=n.n(o);var i=n(32);const{guid:s}=a().utils,{MeasurementReport:c,CORNERSTONE_3D_TAG:l}=i.adaptersSR.Cornerstone3D,u="Cornerstone3DTools",d="0.1",f=["cornerstoneTools@^4.0.0"],p=(e,t)=>{if(!t||"CORNERSTONEJS"===t.CodingSchemeDesignator)return;const n=`${t.CodingSchemeDesignator}:${t.CodeValue}`;return{...e[n],ref:n,...t,text:t.CodeMeaning}},g=(e,t)=>{if(!t||!t.length)return;const n=[];for(let r=0;r<t.length;r++){const o=p(e,t[r][0]||t[r]);o&&n.push(o)}return n.length&&n||void 0};function m(e,t){let{servicesManager:n,extensionManager:a}=e;const i=a.getActiveDataSource()[0],{measurementService:m,displaySetService:y,customizationService:I}=n.services,v=I.getCustomization("codingValues",{}),b=y.getDisplaySetByUID(t),C=m.getSourceMappings(u,d);if(!C||!C.length)throw new Error("Attempting to hydrate measurements service when no mappings present. This shouldn't be reached.");const O=o.DicomMetadataStore.getInstance(b.StudyInstanceUID,b.SeriesInstanceUID,b.SOPInstanceUID),R={},E={};b.measurements.forEach((e=>{const{ReferencedSOPInstanceUID:t,imageId:n,frameNumber:r}=e;R[t]||(R[t]=n,E[t]=[]),E[t][r]||(E[t][r]=n)}));const T=function(e){const t="Imaging Measurements",n="Measurement Group",r="Tracking Identifier",o=S(e.ContentSequence).find(h(t)),a=S(o.ContentSequence).filter(h(n)),i={},s=c.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,u=[];return Object.keys(s).forEach((e=>{u.push(s[e]),i[e]=[]})),a.forEach(((e,t)=>{const n=S(e.ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeMeaning===r)),o=n.TextValue;let[a,i]=o.split(":");f.includes(a)&&(a=l);const s=`${a}:${i}`;n.TextValue=s})),e}(O),D=c.generateToolState(T,R,r.utilities.imageToWorldCoords,r.metaData),w=C.map((e=>e.annotationType)),N={};Object.keys(D).forEach((e=>{w.includes(e)&&(N[e]=D[e])}));const P=[];let U;Object.keys(N).forEach((e=>{N[e].forEach((e=>{const t=e.annotation.data&&e.annotation.data.frameNumber||1,n=E[e.sopInstanceUid][t]||R[e.sopInstanceUid];P.includes(n)||P.push(n)}))}));const x=[];for(let e=0;e<P.length;e++){const t=P[e],{SeriesInstanceUID:n,StudyInstanceUID:o}=r.metaData.get("instance",t);x.includes(n)||x.push(n),U?U!==o&&console.warn("NO SUPPORT FOR SRs THAT HAVE MEASUREMENTS FROM MULTIPLE STUDIES."):U=o}return Object.keys(N).forEach((e=>{N[e].forEach((t=>{const n=t.annotation.data&&t.annotation.data.frameNumber||1,o=E[t.sopInstanceUid][n]||R[t.sopInstanceUid];t.uid=s();const a=r.metaData.get("instance",o),{FrameOfReferenceUID:c}=a,l={annotationUID:t.annotation.annotationUID,data:t.annotation.data,metadata:{toolName:e,referencedImageId:o,FrameOfReferenceUID:c}},f=m.getSource(u,d);l.data.label=function(e){const{findingSites:t=[],finding:n}=e;let r=t.find((e=>"CORNERSTONEFREETEXT"===e.CodeValue));return r?r.CodeMeaning:n&&"CORNERSTONEFREETEXT"===n.CodeValue?n.CodeMeaning:void 0}(t),l.data.finding=p(v,t.finding?.[0]),l.data.findingSites=g(v,t.findingSites),l.data.site=l.data.findingSites?.[0];const S=C.find((t=>t.annotationType===e));m.addRawMeasurement(f,e,{annotation:l},S.toMeasurementSchema,i),P.includes(o)||P.push(o)}))})),b.isHydrated=!0,{StudyInstanceUID:U,SeriesInstanceUIDs:x}}const S=function(e){return Array.isArray(e)?e:[e]},h=e=>t=>t.ConceptNameCodeSequence.CodeMeaning===e},43:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>A});var r=n(216),o=n.n(r),a=n(735);n(432);Object.create(null);function i(){if(console&&console.warn){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];"string"==typeof n[0]&&(n[0]="react-i18next:: ".concat(n[0])),(e=console).warn.apply(e,n)}}var s={};function c(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];"string"==typeof t[0]&&s[t[0]]||("string"==typeof t[0]&&(s[t[0]]=new Date),i.apply(void 0,t))}var l=function(e,t){return function(){if(e.isInitialized)t();else{e.on("initialized",(function n(){setTimeout((function(){e.off("initialized",n)}),0),t()}))}}};function u(e,t,n){e.loadNamespaces(t,l(e,n))}function d(e,t,n,r){"string"==typeof n&&(n=[n]),n.forEach((function(t){e.options.ns.indexOf(t)<0&&e.options.ns.push(t)})),e.loadLanguages(t,l(e,r))}function f(e){return f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f(e)}function p(e){var t=function(e,t){if("object"!==f(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==f(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===f(t)?t:String(t)}function g(e,t,n){return(t=p(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=/&(?:amp|#38|lt|#60|gt|#62|apos|#39|quot|#34|nbsp|#160|copy|#169|reg|#174|hellip|#8230|#x2F|#47);/g,S={"&amp;":"&","&#38;":"&","&lt;":"<","&#60;":"<","&gt;":">","&#62;":">","&apos;":"'","&#39;":"'","&quot;":'"',"&#34;":'"',"&nbsp;":" ","&#160;":" ","&copy;":"©","&#169;":"©","&reg;":"®","&#174;":"®","&hellip;":"…","&#8230;":"…","&#x2F;":"/","&#47;":"/"},h=function(e){return S[e]};var y={bindI18n:"languageChanged",bindI18nStore:"",transEmptyNodeValue:"",transSupportBasicHtmlNodes:!0,transWrapTextNodes:"",transKeepBasicHtmlNodesFor:["br","strong","i","p"],useSuspense:!0,unescape:function(e){return e.replace(m,h)}};var I;function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,p(r.key),r)}}var b=(0,a.createContext)(),C=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.usedNamespaces={}}var t,n,r;return t=e,(n=[{key:"addUsedNamespaces",value:function(e){var t=this;e.forEach((function(e){t.usedNamespaces[e]||(t.usedNamespaces[e]=!0)}))}},{key:"getUsedNamespaces",value:function(){return Object.keys(this.usedNamespaces)}}])&&v(t.prototype,n),r&&v(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function R(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,s=[],c=!0,l=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?O(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function T(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?E(Object(n),!0).forEach((function(t){g(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):E(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var D=function(e,t){var n=(0,a.useRef)();return(0,a.useEffect)((function(){n.current=t?n.current:e}),[e,t]),n.current};function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.i18n,r=(0,a.useContext)(b)||{},o=r.i18n,i=r.defaultNS,s=n||o||I;if(s&&!s.reportNamespaces&&(s.reportNamespaces=new C),!s){c("You will need to pass in an i18next instance by using initReactI18next");var l=function(e,t){return"string"==typeof t?t:t&&"object"===f(t)&&"string"==typeof t.defaultValue?t.defaultValue:Array.isArray(e)?e[e.length-1]:e},p=[l,{},!1];return p.t=l,p.i18n={},p.ready=!1,p}s.options.react&&void 0!==s.options.react.wait&&c("It seems you are still using the old wait option, you may migrate to the new useSuspense behaviour.");var g=T(T(T({},y),s.options.react),t),m=g.useSuspense,S=g.keyPrefix,h=e||i||s.options&&s.options.defaultNS;h="string"==typeof h?[h]:h||["translation"],s.reportNamespaces.addUsedNamespaces&&s.reportNamespaces.addUsedNamespaces(h);var v=(s.isInitialized||s.initializedStoreOnce)&&h.every((function(e){return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.languages&&t.languages.length?void 0!==t.options.ignoreJSONStructure?t.hasLoadedNamespace(e,{lng:n.lng,precheck:function(t,r){if(n.bindI18n&&n.bindI18n.indexOf("languageChanging")>-1&&t.services.backendConnector.backend&&t.isLanguageChangingTo&&!r(t.isLanguageChangingTo,e))return!1}}):function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.languages[0],o=!!t.options&&t.options.fallbackLng,a=t.languages[t.languages.length-1];if("cimode"===r.toLowerCase())return!0;var i=function(e,n){var r=t.services.backendConnector.state["".concat(e,"|").concat(n)];return-1===r||2===r};return!(n.bindI18n&&n.bindI18n.indexOf("languageChanging")>-1&&t.services.backendConnector.backend&&t.isLanguageChangingTo&&!i(t.isLanguageChangingTo,e)||!t.hasResourceBundle(r,e)&&t.services.backendConnector.backend&&(!t.options.resources||t.options.partialBundledLanguages)&&(!i(r,e)||o&&!i(a,e)))}(e,t,n):(c("i18n.languages were undefined or empty",t.languages),!0)}(e,s,g)}));function O(){return s.getFixedT(t.lng||null,"fallback"===g.nsMode?h:h[0],S)}var E=R((0,a.useState)(O),2),w=E[0],N=E[1],P=h.join();t.lng&&(P="".concat(t.lng).concat(P));var U=D(P),x=(0,a.useRef)(!0);(0,a.useEffect)((function(){var e=g.bindI18n,n=g.bindI18nStore;function r(){x.current&&N(O)}return x.current=!0,v||m||(t.lng?d(s,t.lng,h,(function(){x.current&&N(O)})):u(s,h,(function(){x.current&&N(O)}))),v&&U&&U!==P&&x.current&&N(O),e&&s&&s.on(e,r),n&&s&&s.store.on(n,r),function(){x.current=!1,e&&s&&e.split(" ").forEach((function(e){return s.off(e,r)})),n&&s&&n.split(" ").forEach((function(e){return s.store.off(e,r)}))}}),[s,P]);var M=(0,a.useRef)(!0);(0,a.useEffect)((function(){x.current&&!M.current&&N(O),M.current=!1}),[s,S]);var k=[w,s,v];if(k.t=w,k.i18n=s,k.ready=v,v)return k;if(!v&&!m)return k;throw new Promise((function(e){t.lng?d(s,t.lng,h,(function(){return e()})):u(s,h,(function(){return e()}))}))}var N=n(762),P=n.n(N),U=n(365),x=n(369),M=n(414);function k(){return k=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},k.apply(this,arguments)}const{formatDate:j}=N.utils;function q(e){const{children:t,dataSource:n,displaySets:r,viewportIndex:o,viewportLabel:i,viewportOptions:s,servicesManager:c,extensionManager:l}=e,{displaySetService:u,cornerstoneViewportService:d,measurementService:f}=c.services;if(r.length>1)throw new Error("SR viewport should only have a single display set");const p=r[0],[g,m]=(0,x.useViewportGrid)(),[S,h]=(0,a.useState)(0),[y,I]=(0,a.useState)(1),[v,b]=(0,a.useState)(null),[C,O]=(0,a.useState)(null),[R,E]=(0,a.useState)(null),{viewports:T,activeViewportIndex:D}=g;let N,q;if(l.registeredExtensionIds.includes("@ohif/extension-measurement-tracking")){const e=l.getModuleEntry("@ohif/extension-measurement-tracking.contextModule.TrackedMeasurementsContext"),t=(0,a.useContext)(e.context);N=t?.[0],q=t?.[1]}q||(N=null,q=(e,t)=>{let{displaySetInstanceUID:n}=t;f.clearMeasurements();const{SeriesInstanceUIDs:r}=(0,M.Z)({servicesManager:c,extensionManager:l},n),o=u.getDisplaySetsForSeries(r[0]);o.length&&m.setDisplaySetsForViewports([{viewportIndex:D,displaySetInstanceUIDs:[o[0].displaySetInstanceUID]}])});const A=(0,a.useCallback)((e=>{const{measurements:t}=p;(0,U.l2)(R,t.map((e=>e.TrackingUniqueIdentifier)),e)}),[R,S,p]),L=e=>{E(e.detail.element)},_=(0,a.useCallback)((e=>{const{StudyInstanceUID:t,displaySetInstanceUID:n,sopClassUids:r}=p;t&&n&&(r&&r.length>1&&console.warn("More than one SOPClassUID in the same series is not yet supported."),async function(e,t,n){const{measurements:r}=e,o=r[t],{displaySetInstanceUID:a}=o,i=n.getDisplaySetByUID(a),s=i.images[0],c={PatientID:s.PatientID,PatientName:s.PatientName,PatientSex:s.PatientSex,PatientAge:s.PatientAge,SliceThickness:s.SliceThickness,StudyDate:s.StudyDate,SeriesDescription:s.SeriesDescription,SeriesInstanceUID:s.SeriesInstanceUID,SeriesNumber:s.SeriesNumber,ManufacturerModelName:s.ManufacturerModelName,SpacingBetweenSlices:s.SpacingBetweenSlices};return{referencedDisplaySetMetadata:c,referencedDisplaySet:i}}(p,e,u).then((t=>{let{referencedDisplaySet:n,referencedDisplaySetMetadata:r}=t;if(h(e),b(n),O(r),n.displaySetInstanceUID===v?.displaySetInstanceUID){const{measurements:t}=p,n=d.getViewportInfoByIndex(o),r=d.getCornerstoneViewport(n.getViewportId()),a=r.getImageIds().indexOf(t[e].imageId);-1!==a&&r.setImageIdIndex(a)}})))}),[n,p,v,o]),F=(0,a.useCallback)((()=>{if(!v)return null;const{component:t}=l.getModuleEntry("@ohif/extension-cornerstone.viewportModule.cornerstone"),{measurements:n}=p,r=n[S];if(!r)return null;const o=v.images.findIndex((e=>e.imageId===r.imageId));return a.createElement(t,k({},e,{displaySets:[v],viewportOptions:{...s,toolGroupId:"SRToolGroup",viewportType:"stack",positionIds:null},onElementEnabled:L,initialImageIndex:o}))}),[v,o,S]),V=(0,a.useCallback)((e=>{let t=S;"right"===e?(t++,t>=y&&(t=0)):(t--,t<0&&(t=y-1)),A(t),_(t)}),[S,y,_,A]);(0,a.useEffect)((()=>{const e=u.subscribe(u.EVENTS.DISPLAY_SETS_REMOVED,(e=>{let{displaySetInstanceUIDs:t}=e;const n=T[D];t.includes(n.displaySetInstanceUID)&&m.setDisplaySetsForViewport({viewportIndex:D,displaySetInstanceUIDs:[]})}));return()=>{e.unsubscribe()}}),[]),(0,a.useEffect)((()=>{p.isLoaded||p.load();const e=p.measurements.length;I(e)}),[p]),(0,a.useEffect)((()=>{R&&p.isLoaded&&A(S)}),[S,R,A,p]);let $=N?.context?.trackedSeries?.length>0;(0,a.useEffect)((()=>{$=N?.context?.trackedSeries?.length>0}),[N]),(0,a.useEffect)((()=>{_(S)}),[n,p]);let B=null;if(!v||!C)return null;t&&t.length&&(B=t.map(((e,t)=>e&&a.cloneElement(e,{viewportIndex:o,key:t}))));const{PatientID:G,PatientName:W,PatientSex:H,PatientAge:Y,SliceThickness:z,ManufacturerModelName:X,StudyDate:J,SeriesDescription:K,SpacingBetweenSlices:Z,SeriesNumber:Q}=C;return a.createElement(a.Fragment,null,a.createElement(x.ViewportActionBar,{onDoubleClick:e=>{e.stopPropagation(),e.preventDefault()},onArrowsClick:V,getStatusComponent:()=>function(e){let{srDisplaySet:t,viewportIndex:n,isRehydratable:r,isLocked:o,sendTrackedMeasurementsEvent:i}=e;const s=()=>{i("HYDRATE_SR",{displaySetInstanceUID:t.displaySetInstanceUID,viewportIndex:n})},{t:c}=w("Common"),l=c("LOAD"),u=r&&!o?3:r&&o?2:1;let d=null,f=null;switch(u){case 1:f=()=>a.createElement(x.Icon,{name:"status-alert"}),d=()=>a.createElement("div",null,"This structured report is not compatible",a.createElement("br",null),"with this application.");break;case 2:f=()=>a.createElement(x.Icon,{name:"status-locked"}),d=()=>a.createElement("div",null,"This structured report is currently read-only",a.createElement("br",null),"because you are tracking measurements in",a.createElement("br",null),"another viewport.");break;case 3:f=()=>a.createElement(x.Icon,{name:"status-untracked"}),d=()=>a.createElement("div",null,`Click ${l} to restore measurements.`)}const p=()=>a.createElement("div",{className:"flex h-6 leading-6 cursor-default text-sm text-white"},a.createElement("div",{className:"min-w-[45px] flex items-center p-1 rounded-l-xl rounded-r bg-customgray-100"},a.createElement(f,null),a.createElement("span",{className:"ml-1"},"SR")),3===u&&a.createElement("div",{className:"ml-1 px-1.5 rounded cursor-pointer hover:text-black bg-primary-main hover:bg-primary-light",onMouseUp:s},l));return a.createElement(a.Fragment,null,d&&a.createElement(x.Tooltip,{content:a.createElement(d,null),position:"bottom-left"},a.createElement(p,null)),!d&&a.createElement(p,null))}({srDisplaySet:p,viewportIndex:o,isTracked:!1,isRehydratable:p.isRehydratable,isLocked:$,sendTrackedMeasurementsEvent:q}),studyData:{label:i,useAltStyling:!0,studyDate:j(J),currentSeries:Q,seriesDescription:K||"",patientInformation:{patientName:W?P().utils.formatPN(W.Alphabetic):"",patientSex:H||"",patientAge:Y||"",MRN:G||"",thickness:z?`${z.toFixed(2)}mm`:"",spacing:void 0!==Z?`${Z.toFixed(2)}mm`:"",scanner:X||""}}}),a.createElement("div",{className:"relative flex flex-row w-full h-full overflow-hidden"},F(),B))}q.propTypes={displaySets:o().arrayOf(o().object),viewportIndex:o().number.isRequired,dataSource:o().object,children:o().node,viewportLabel:o().string,customProps:o().object,viewportOptions:o().object,viewportLabel:o().string,servicesManager:o().instanceOf(N.ServicesManager).isRequired,extensionManager:o().instanceOf(N.ExtensionManager).isRequired},q.defaultProps={customProps:{}};const A=q},516:e=>{"use strict";var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(e){return!1}}()?Object.assign:function(e,o){for(var a,i,s=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),c=1;c<arguments.length;c++){for(var l in a=Object(arguments[c]))n.call(a,l)&&(s[l]=a[l]);if(t){i=t(a);for(var u=0;u<i.length;u++)r.call(a,i[u])&&(s[i[u]]=a[i[u]])}}return s}},459:(e,t,n)=>{"use strict";var r=n(704);function o(){}function a(){}a.resetWarningCache=o,e.exports=function(){function e(e,t,n,o,a,i){if(i!==r){var s=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw s.name="Invariant Violation",s}}function t(){return e}e.isRequired=e;var n={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:a,resetWarningCache:o};return n.PropTypes=n,n}},216:(e,t,n)=>{e.exports=n(459)()},704:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},447:(e,t,n)=>{"use strict";var r=n(516),o=60103,a=60106;t.Fragment=60107,t.StrictMode=60108,t.Profiler=60114;var i=60109,s=60110,c=60112;t.Suspense=60113;var l=60115,u=60116;if("function"==typeof Symbol&&Symbol.for){var d=Symbol.for;o=d("react.element"),a=d("react.portal"),t.Fragment=d("react.fragment"),t.StrictMode=d("react.strict_mode"),t.Profiler=d("react.profiler"),i=d("react.provider"),s=d("react.context"),c=d("react.forward_ref"),t.Suspense=d("react.suspense"),l=d("react.memo"),u=d("react.lazy")}var f="function"==typeof Symbol&&Symbol.iterator;function p(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var g={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m={};function S(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||g}function h(){}function y(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||g}S.prototype.isReactComponent={},S.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(p(85));this.updater.enqueueSetState(this,e,t,"setState")},S.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},h.prototype=S.prototype;var I=y.prototype=new h;I.constructor=y,r(I,S.prototype),I.isPureReactComponent=!0;var v={current:null},b=Object.prototype.hasOwnProperty,C={key:!0,ref:!0,__self:!0,__source:!0};function O(e,t,n){var r,a={},i=null,s=null;if(null!=t)for(r in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(i=""+t.key),t)b.call(t,r)&&!C.hasOwnProperty(r)&&(a[r]=t[r]);var c=arguments.length-2;if(1===c)a.children=n;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];a.children=l}if(e&&e.defaultProps)for(r in c=e.defaultProps)void 0===a[r]&&(a[r]=c[r]);return{$$typeof:o,type:e,key:i,ref:s,props:a,_owner:v.current}}function R(e){return"object"==typeof e&&null!==e&&e.$$typeof===o}var E=/\/+/g;function T(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function D(e,t,n,r,i){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case o:case a:c=!0}}if(c)return i=i(c=e),e=""===r?"."+T(c,0):r,Array.isArray(i)?(n="",null!=e&&(n=e.replace(E,"$&/")+"/"),D(i,t,n,"",(function(e){return e}))):null!=i&&(R(i)&&(i=function(e,t){return{$$typeof:o,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,n+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(E,"$&/")+"/")+e)),t.push(i)),1;if(c=0,r=""===r?".":r+":",Array.isArray(e))for(var l=0;l<e.length;l++){var u=r+T(s=e[l],l);c+=D(s,t,n,u,i)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(s=e.next()).done;)c+=D(s=s.value,t,n,u=r+T(s,l++),i);else if("object"===s)throw t=""+e,Error(p(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return c}function w(e,t,n){if(null==e)return e;var r=[],o=0;return D(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function N(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var P={current:null};function U(){var e=P.current;if(null===e)throw Error(p(321));return e}var x={ReactCurrentDispatcher:P,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:v,IsSomeRendererActing:{current:!1},assign:r};t.Children={map:w,forEach:function(e,t,n){w(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return w(e,(function(){t++})),t},toArray:function(e){return w(e,(function(e){return e}))||[]},only:function(e){if(!R(e))throw Error(p(143));return e}},t.Component=S,t.PureComponent=y,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=x,t.cloneElement=function(e,t,n){if(null==e)throw Error(p(267,e));var a=r({},e.props),i=e.key,s=e.ref,c=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,c=v.current),void 0!==t.key&&(i=""+t.key),e.type&&e.type.defaultProps)var l=e.type.defaultProps;for(u in t)b.call(t,u)&&!C.hasOwnProperty(u)&&(a[u]=void 0===t[u]&&void 0!==l?l[u]:t[u])}var u=arguments.length-2;if(1===u)a.children=n;else if(1<u){l=Array(u);for(var d=0;d<u;d++)l[d]=arguments[d+2];a.children=l}return{$$typeof:o,type:e.type,key:i,ref:s,props:a,_owner:c}},t.createContext=function(e,t){return void 0===t&&(t=null),(e={$$typeof:s,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider={$$typeof:i,_context:e},e.Consumer=e},t.createElement=O,t.createFactory=function(e){var t=O.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:c,render:e}},t.isValidElement=R,t.lazy=function(e){return{$$typeof:u,_payload:{_status:-1,_result:e},_init:N}},t.memo=function(e,t){return{$$typeof:l,type:e,compare:void 0===t?null:t}},t.useCallback=function(e,t){return U().useCallback(e,t)},t.useContext=function(e,t){return U().useContext(e,t)},t.useDebugValue=function(){},t.useEffect=function(e,t){return U().useEffect(e,t)},t.useImperativeHandle=function(e,t,n){return U().useImperativeHandle(e,t,n)},t.useLayoutEffect=function(e,t){return U().useLayoutEffect(e,t)},t.useMemo=function(e,t){return U().useMemo(e,t)},t.useReducer=function(e,t,n){return U().useReducer(e,t,n)},t.useRef=function(e){return U().useRef(e)},t.useState=function(e){return U().useState(e)},t.version="17.0.2"},735:(e,t,n)=>{"use strict";e.exports=n(447)},432:e=>{e.exports={area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}},32:e=>{"use strict";e.exports=o},464:e=>{"use strict";e.exports=r},867:e=>{"use strict";e.exports=n},762:t=>{"use strict";t.exports=e},369:e=>{"use strict";e.exports=i},836:e=>{"use strict";e.exports=a},845:e=>{"use strict";e.exports=t}},u={};function d(e){var t=u[e];if(void 0!==t)return t.exports;var n=u[e]={exports:{}};return l[e](n,n.exports,d),n.exports}d.m=l,s=[],d.O=(e,t,n,r)=>{if(!t){var o=1/0;for(l=0;l<s.length;l++){for(var[t,n,r]=s[l],a=!0,i=0;i<t.length;i++)(!1&r||o>=r)&&Object.keys(d.O).every((e=>d.O[e](t[i])))?t.splice(i--,1):(a=!1,r<o&&(o=r));if(a){s.splice(l--,1);var c=n();void 0!==c&&(e=c)}}return e}r=r||0;for(var l=s.length;l>0&&s[l-1][2]>r;l--)s[l]=s[l-1];s[l]=[t,n,r]},d.F={},d.E=e=>{Object.keys(d.F).map((t=>{d.F[t](e)}))},d.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return d.d(t,{a:t}),t},d.d=(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),d.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c={143:0},d.F.j=e=>{if(!d.o(c,e)||void 0===c[e]){c[e]=null;var t=document.createElement("link");d.nc&&t.setAttribute("nonce",d.nc),t.rel="prefetch",t.as="script",t.href=d.p+d.u(e),document.head.appendChild(t)}},d.O.j=e=>0===c[e],d.O(0,[143],(()=>{d.E(143)}),5);var f={};return(()=>{"use strict";d.r(f),d.d(f,{createReferencedImageDisplaySet:()=>te,default:()=>ae,hydrateStructuredReport:()=>K.Z,srProtocol:()=>$});var e=d(735);const t=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-sr"}').u2,n="dicom-sr",r=`${t}.sopClassHandlerModule.${n}`;var o=d(762),a=d.n(o),i=d(845),s=d(867),c=d(464),l=d(365);const u={POINT:"POINT",MULTIPOINT:"MULTIPOINT",POLYLINE:"POLYLINE",CIRCLE:"CIRCLE",ELLIPSE:"ELLIPSE"};class p extends s.AnnotationTool{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{}}),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{element:r}=n;let o=s.annotation.state.getAnnotations(this.getToolName(),r);if(!o?.length)return;if(o=this.filterInteractableAnnotationsForElement(r,o),!o?.length)return;const a=(0,l.yR)(r),{activeIndex:i,trackingUniqueIdentifiers:c}=a,d=c[i],f=o.filter((e=>c.includes(e.data?.cachedStats?.TrackingUniqueIdentifier)));if(!n._actors?.size)return;const p={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<f.length;e++){const r=f[e],o=r.annotationUID,{renderableData:a}=r.data.cachedStats,{cachedStats:i}=r.data,{referencedImageId:c}=r.metadata;p.annotationUID=o;const l=this.getStyle("lineWidth",p,r),g=this.getStyle("lineDash",p,r),m={color:i.TrackingUniqueIdentifier===d?"rgb(0, 255, 0)":this.getStyle("color",p,r),lineDash:g,lineWidth:l};Object.keys(a).forEach((e=>{const i=a[e];let l,d;switch(e){case u.POINT:l=this.renderPoint;break;case u.MULTIPOINT:l=this.renderMultipoint;break;case u.POLYLINE:l=this.renderPolyLine;break;case u.CIRCLE:l=this.renderEllipse;break;case u.ELLIPSE:l=this.renderEllipse,d=s.utilities.math.ellipse.getCanvasEllipseCorners;break;default:throw new Error(`Unsupported GraphicType: ${e}`)}const f=l(t,n,i,o,c,m);this.renderTextBox(t,n,f,d,r,p,m)}))}}}_getTextBoxLinesFromLabels(e){const t=Math.min(e.length,3),n=[];for(let r=0;r<t;r++){const t=e[r];n.push(`${m(t.label)}${t.value}`)}return n}renderPolyLine(e,t,n,r,o,a){const i={color:a.color,width:a.lineWidth};let c=[];return n.map(((n,o)=>{const a=n.map((e=>t.worldToCanvas(e))),l=`${o}`;2===a.length?s.drawing.drawLine(e,r,l,a[0],a[1],i):s.drawing.drawPolyline(e,r,l,a,i),c=c.concat(a)})),c}renderMultipoint(e,t,n,r,o,a){let i;n.map(((n,o)=>{i=n.map((e=>t.worldToCanvas(e)));s.drawing.drawHandles(e,r,"0",i,{color:a.color})}))}renderPoint(e,t,n,r,o,a){const i=[];return n.map(((n,l)=>{const u=n[0];i.push(t.worldToCanvas(u));const d=c.metaData.get("imagePixelModule",o);let f=10,p=10;if(d){const{columns:e,rows:t}=d;f=e/10,p=t/10}const g=c.utilities.worldToImageCoords(o,u),m=c.utilities.imageToWorldCoords(o,[g[0]+f,g[1]+p]);i.push(t.worldToCanvas(m));const S=`${l}`;s.drawing.drawArrow(e,r,S,i[1],i[0],{color:a.color,width:a.lineWidth})})),i}renderEllipse(e,t,n,r,o,a){let i;return n.map(((n,o)=>{if(0===n.length)return;const c=n,l=t.getRotation();let u;i=c.map((e=>t.worldToCanvas(e))),u=90==l||270==l?s.utilities.math.ellipse.getCanvasEllipseCorners([i[2],i[3],i[0],i[1]]):s.utilities.math.ellipse.getCanvasEllipseCorners(i);const d=`${o}`;s.drawing.drawEllipse(e,r,d,u[0],u[1],{color:a.color,width:a.lineWidth})})),i}renderTextBox(e,t,n,r,o,a){let i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};if(!n||!o)return;const{annotationUID:c,data:l={}}=o,{label:u}=l,{color:d}=i;let f=n;"function"==typeof r&&(f=r(n));const p=this._getTextBoxLinesFromLabels(u),g=s.utilities.drawing.getTextBoxCoordsCanvas(f);o.data.handles.textBox.worldPosition=t.canvasToWorld(g);const m=t.worldToCanvas(o.data.handles.textBox.worldPosition),S=this.getLinkedTextBoxStyle(a,o),h=s.drawing.drawLinkedTextBox(e,c,"1",p,m,n,{},{...S,color:d}),{x:y,y:I,width:v,height:b}=h;o.data.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([y,I]),topRight:t.canvasToWorld([y+v,I]),bottomLeft:t.canvasToWorld([y,I+b]),bottomRight:t.canvasToWorld([y+v,I+b])}}}p.toolName="DICOMSRDisplay";const g={"Short Axis":"W: ","Long Axis":"L: ",AREA:"Area: ",Length:"",CORNERSTONEFREETEXT:""};function m(e){const t=g[e];return void 0!==t?t:e}const S={DICOMSRDisplay:p.toolName,SRLength:"SRLength",SRBidirectional:"SRBidirectional",SREllipticalROI:"SREllipticalROI",SRCircleROI:"SRCircleROI",SRArrowAnnotate:"SRArrowAnnotate",SRAngle:"SRAngle",SRCobbAngle:"SRCobbAngle",SRRectangleROI:"SRRectangleROI",SRPlanarFreehandROI:"SRPlanarFreehandROI"},h=1e-4;function y(e,t,n){const r=S.DICOMSRDisplay,o={TrackingUniqueIdentifier:e.TrackingUniqueIdentifier,renderableData:{},labels:e.labels,imageId:t};e.coords.forEach((n=>{const{GraphicType:r,GraphicData:a}=n;void 0===o.renderableData[r]&&(o.renderableData[r]=[]),o.renderableData[r].push(function(e,t,n,r){const[o,a]=r.split(":");let s;switch(e){case u.POINT:case u.MULTIPOINT:case u.POLYLINE:s=[];for(let e=0;e<t.length;e+=2){const r=c.utilities.imageToWorldCoords(n,[t[e],t[e+1]]);s.push(r)}break;case u.CIRCLE:{const e=[];for(let r=0;r<t.length;r+=2){const o=c.utilities.imageToWorldCoords(n,[t[r],t[r+1]]);e.push(o)}const r=e[0],o=e[1],a=i.vec3.distance(r,o),l=c.metaData.get("imagePlaneModule",n);if(!l)throw new Error("No imagePlaneModule found");const{columnCosines:u,rowCosines:d}=l,f=i.vec3.create();i.vec3.scaleAndAdd(f,r,u,a);const p=i.vec3.create();i.vec3.scaleAndAdd(p,r,u,-a);const g=i.vec3.create();i.vec3.scaleAndAdd(g,r,d,a);const m=i.vec3.create();i.vec3.scaleAndAdd(m,r,d,-a),s=[f,p,g,m];break}case u.ELLIPSE:{const e=[];for(let r=0;r<t.length;r+=2){const o=c.utilities.imageToWorldCoords(n,[t[r],t[r+1]]);e.push(o)}const r=i.vec3.fromValues(...e[0]),o=i.vec3.fromValues(...e[1]),a=i.vec3.fromValues(...e[2]),l=i.vec3.fromValues(...e[3]),u=i.vec3.create();i.vec3.sub(u,o,r),i.vec3.normalize(u,u);const d=i.vec3.create();i.vec3.sub(d,l,a),i.vec3.normalize(d,d);const f=c.metaData.get("imagePlaneModule",n);if(!f)throw new Error("imageId does not have imagePlaneModule metadata");const{columnCosines:p}=f,g=i.vec3.fromValues(...p),m=Math.abs(i.vec3.dot(g,u)),S=Math.abs(i.vec3.dot(g,d)),y=Math.abs(m),I=Math.abs(S);s=[],Math.abs(y-1)<h?s=[e[0],e[1],e[2],e[3]]:Math.abs(I-1)<h?s=[e[2],e[3],e[0],e[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");break}default:console.warn("Unsupported GraphicType:",e)}return s}(r,a,t,e.TrackingIdentifier))}));const a=c.metaData.get("imagePlaneModule",t),l=s.annotation.state.getAnnotationManager(),d=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence[0]?.ReferencedFrameNumber||1,f={annotationUID:e.TrackingUniqueIdentifier,metadata:{FrameOfReferenceUID:a.frameOfReferenceUID,toolName:r,referencedImageId:t},data:{label:e.labels,handles:{textBox:{}},cachedStats:{TrackingUniqueIdentifier:o.TrackingUniqueIdentifier,renderableData:o.renderableData},frameNumber:d}};l.addAnnotation(f),e.loaded=!0,e.imageId=t,e.displaySetInstanceUID=n,e.ReferencedSOPInstanceUID=e.coords[0].ReferencedSOPSequence.ReferencedSOPInstanceUID,e.frameNumber=d,delete e.coords}var I=d(32);const v=I.adaptersSR.Cornerstone3D.MeasurementReport.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,b=["cornerstoneTools@^4.0.0"],C=v.CORNERSTONE_3D_TAG;const{CodeScheme:O}=I.adaptersSR.Cornerstone3D,{ImageSet:R,MetadataProvider:E}=o.classes,T=["1.2.840.10008.5.1.4.1.1.88.11","1.2.840.10008.5.1.4.1.1.88.22","1.2.840.10008.5.1.4.1.1.88.33","1.2.840.10008.5.1.4.1.1.88.34"],D="Cornerstone3DTools",w="0.1",N=(e,t)=>{t.forEach((t=>{if(t.StudyInstanceUID!==e)throw console.warn("Not all instances have the same UID",e,t),new Error(`Instances ${t.SOPInstanceUID} does not belong to ${e}`)}))},P={ImagingMeasurementReport:"126000",ImageLibrary:"111028",ImagingMeasurements:"126010",MeasurementGroup:"125007",ImageLibraryGroup:"126200",TrackingUniqueIdentifier:"112040",TrackingIdentifier:"112039",Finding:"121071",FindingSite:"G-C0E3",CornerstoneFreeText:O.codeValues.CORNERSTONEFREETEXT},U={SRT:"SRT",CornerstoneCodeSchemes:[O.CodingSchemeDesignator,"CST4"]},x={INFERRED_FROM:"INFERRED FROM",CONTAINS:"CONTAINS"},M="CORNERSTONEFREETEXT";function k(e,t){return this.instances.push(...e),o.utils.sortStudyInstances(this.instances),this.instance=this.instances[this.instances.length-1],this.isLoaded=!1,this}function j(e,t,n){if(!e||!e.length)throw new Error("No instances were provided");o.utils.sortStudyInstances(e);const a=e[e.length-1],{StudyInstanceUID:i,SeriesInstanceUID:s,SOPInstanceUID:c,SeriesDescription:l,SeriesNumber:u,SeriesDate:d,ConceptNameCodeSequence:f,SOPClassUID:p}=a;if(N(a.StudyInstanceUID,e),!f||f.CodeValue!==P.ImagingMeasurementReport)return t.services.uiNotificationService.show({title:"DICOM SR",message:"OHIF only supports TID1500 Imaging Measurement Report Structured Reports. The SR you’re trying to view is not supported.",type:"warning",duration:6e3}),[];const g={Modality:"SR",displaySetInstanceUID:o.utils.guid(),SeriesDescription:l,SeriesNumber:u,SeriesDate:d,SOPInstanceUID:c,SeriesInstanceUID:s,StudyInstanceUID:i,SOPClassHandlerId:r,SOPClassUID:p,instances:e,referencedImages:null,measurements:null,isDerivedDisplaySet:!0,isLoaded:!1,sopClassUids:T,instance:a,addInstances:k};return g.load=()=>function(e,t,n){const{displaySetService:r,measurementService:o}=t.services,a=n.getDataSources(),i=a[0],{ContentSequence:s}=e.instance;e.referencedImages=function(e){const t=F(e.find((e=>e.ConceptNameCodeSequence.CodeValue===P.ImageLibrary)).ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeValue===P.ImageLibraryGroup)),n=[];return F(t.ContentSequence).forEach((e=>{const{ReferencedSOPSequence:t}=e;if(t)for(const e of F(t))if(e.ReferencedSOPClassUID){const{ReferencedSOPClassUID:t,ReferencedSOPInstanceUID:r}=e;n.push({ReferencedSOPClassUID:t,ReferencedSOPInstanceUID:r})}})),n}(s),e.measurements=function(e){const t=e.find((e=>e.ConceptNameCodeSequence.CodeValue===P.ImagingMeasurements)),n=function(e){const t={};return e.forEach((e=>{const n=F(e.ContentSequence),r=n.find((e=>e.ConceptNameCodeSequence.CodeValue===P.TrackingUniqueIdentifier));r||console.warn("No Tracking Unique Identifier, skipping ambiguous measurement.");const o=r.UID;void 0===t[o]?t[o]=[...n]:n.forEach((e=>{e.ConceptNameCodeSequence.CodeValue!==P.TrackingUniqueIdentifier&&t[o].push(e)}))})),t}(F(t.ContentSequence).filter((e=>e.ConceptNameCodeSequence.CodeValue===P.MeasurementGroup))),r=[];return Object.keys(n).forEach((e=>{const t=function(e){if(e.some((e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)))return function(e){const t=e.find((e=>"SCOORD"===e.ValueType)),n=e.find((e=>"UIDREF"===e.ValueType)),r=e.find((e=>e.ConceptNameCodeSequence.CodeValue===P.TrackingIdentifier));if(!t)return void console.warn(`graphic ValueType ${t.ValueType} not currently supported, skipping annotation.`);const o=e.filter((e=>"NUM"===e.ValueType)),a={loaded:!1,labels:[],coords:[L(t)],TrackingUniqueIdentifier:n.UID,TrackingIdentifier:r.TextValue};return o.forEach((e=>{const{ConceptNameCodeSequence:t,MeasuredValueSequence:n}=e;n&&a.labels.push(_(t,n))})),a}(e);return function(e){const t=e.filter((e=>"NUM"===e.ValueType)),n=e.find((e=>"UIDREF"===e.ValueType)),r=e.find((e=>e.ConceptNameCodeSequence.CodeValue===P.TrackingIdentifier)),o=e.find((e=>e.ConceptNameCodeSequence.CodeValue===P.Finding)),a=e.filter((e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===U.SRT&&e.ConceptNameCodeSequence.CodeValue===P.FindingSite)),i={loaded:!1,labels:[],coords:[],TrackingUniqueIdentifier:n.UID,TrackingIdentifier:r.TextValue};o&&U.CornerstoneCodeSchemes.includes(o.ConceptCodeSequence.CodingSchemeDesignator)&&o.ConceptCodeSequence.CodeValue===P.CornerstoneFreeText&&i.labels.push({label:M,value:o.ConceptCodeSequence.CodeMeaning});if(a.length){const e=a.find((e=>U.CornerstoneCodeSchemes.includes(e.ConceptCodeSequence.CodingSchemeDesignator)&&e.ConceptCodeSequence.CodeValue===P.CornerstoneFreeText));e&&i.labels.push({label:M,value:e.ConceptCodeSequence.CodeMeaning})}return t.forEach((e=>{const{ConceptNameCodeSequence:t,ContentSequence:n,MeasuredValueSequence:r}=e,{ValueType:o}=n;if("SCOORD"===!o)return void console.warn(`Graphic ${o} not currently supported, skipping annotation.`);const a=L(n);a&&i.coords.push(a),r&&i.labels.push(_(t,r))})),i}(e)}(n[e]);t&&r.push(t)})),r}(s);const c=o.getSourceMappings(D,w);e.isHydrated=!1,e.isRehydratable=function(e,t){if(!t||!t.length)return!1;const n=t.map((e=>e.annotationType)),{measurements:r}=e,o=Object.keys(v).filter((e=>"function"==typeof v[e].isValidCornerstoneTrackingIdentifier)),a=[];o.forEach((e=>{n.includes(e)&&a.push(v[e])}));for(let e=0;e<r.length;e++){const{TrackingIdentifier:t}=r[e]||{};if(a.some((e=>{let[n,r]=t.split(":");b.includes(n)&&(n=C);const o=`${n}:${r}`;return e.isValidCornerstoneTrackingIdentifier(o)})))return!0;console.log("Measurement is not rehydratable",t,r[e])}return console.log("No measurements found which were rehydratable"),!1}(e,c),e.isLoaded=!0,r.activeDisplaySets.forEach((t=>{q(e,t,i)})),r.subscribe(r.EVENTS.DISPLAY_SETS_ADDED,(t=>{const{displaySetsAdded:n}=t;n.forEach((t=>{q(e,t,i)}))}))}(g,t,n),[g]}function q(e,t,n){let r=e.measurements.filter((e=>!1===e.loaded));if(0===r.length)return;if(!t instanceof R)return;const{sopClassUids:o,images:a}=t;if(r=r.filter((e=>e.coords.some((e=>o.includes(e.ReferencedSOPSequence.ReferencedSOPClassUID))))),0===r.length)return;const i=[];r.forEach((e=>{const{coords:t}=e;t.forEach((e=>{const t=e.ReferencedSOPSequence.ReferencedSOPInstanceUID;i.includes(t)||i.push(t)}))}));const s=n.getImageIdsForDisplaySet(t);for(const e of s){if(!r.length)return;const{SOPInstanceUID:n,frameNumber:o}=E.getUIDsFromImageID(e);if(i.includes(n))for(let a=r.length-1;a>=0;a--){const i=r[a];A(i,n,o)&&(y(i,e,t.displaySetInstanceUID),r.splice(a,1))}}}function A(e,t,n){const{coords:r}=e,o=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence[0]?.ReferencedFrameNumber||1;if(n&&Number(n)!==Number(o))return!1;for(let e=0;e<r.length;e++){const n=r[e],{ReferencedSOPInstanceUID:o}=n.ReferencedSOPSequence;if(o===t)return!0}}function L(e){const{ValueType:t,RelationshipType:n,GraphicType:r,GraphicData:o}=e;if(n!=x.INFERRED_FROM&&n!=x.CONTAINS)return void console.warn(`Relationshiptype === ${n}. Cannot deal with NON TID-1400 SCOORD group with RelationshipType !== "INFERRED FROM" or "CONTAINS"`);const a={ValueType:t,GraphicType:r,GraphicData:o};if("SCOORD"===t){const{ReferencedSOPSequence:t}=e.ContentSequence;a.ReferencedSOPSequence=t}else if("SCOORD3D"===t){const{ReferencedFrameOfReferenceSequence:t}=e.ContentSequence;a.ReferencedFrameOfReferenceSequence=t}return a}function _(e,t){const{CodeMeaning:n}=e,{NumericValue:r,MeasurementUnitsCodeSequence:o}=t,{CodeValue:a}=o;return{label:n,value:`${r?Number(r).toFixed(2):""} ${a}`}}function F(e){return e?Array.isArray(e)?e:[e]:[]}const V=function(e){let{servicesManager:t,extensionManager:r}=e;return[{name:n,sopClassUids:T,getDisplaySetsFromSeries:e=>j(e,t,r)}]},$={id:"@ohif/sr",hasUpdatedPriorsInformation:!1,name:"SR Key Images",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{srDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SR"}}]}},stages:[{name:"SR Key Images",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId"}]}]}]};var B=d(836),G=d.n(B);const{log:W}=a();const H=function(e,t){const n={};function r(r,o){if(!r.metadata?.referencedImageId)return void W.warn(`[DICOMSR] No referencedImageId found for ${o} ${r.id}`);const a=r.metadata.referencedImageId;n[a]||(n[a]={});const i=n[a];i[o]||(i[o]={data:[]});const s=e.find((e=>e.uid===r.annotationUID)),c=i[o].data;let{finding:l}=s;const u=[];s.label&&(t.includes(o)?l={CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:s.label}:u.push({CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:s.label})),s.findingSites&&u.push(...s.findingSites);const d=Object.assign({},r,{finding:l,findingSites:u});c.push(d)}const o=e.map((e=>e.uid)).slice(),a=s.annotation.state.getAnnotationManager(),i=a.getFramesOfReference();for(let e=0;e<i.length;e++){const t=i[e],s=a.getAnnotations(t),c=Object.keys(s);for(let e=0;e<c.length;e++){const t=c[e],a=s[t];if(a)for(let e=0;e<a.length;e++){const i=a[e],s=o.findIndex((e=>e===i.annotationUID));if(-1!==s&&(r(i,t),o.splice(s,1),!o.length))return n}}}return n},{MeasurementReport:Y}=I.adaptersSR.Cornerstone3D,{log:z}=a(),X=e=>{let{}=e;const t={downloadReport:e=>{let{measurementData:n,additionalFindingTypes:r,options:o={}}=e;const a=t.generateReport(n,r,o),i=G().data.datasetToBlob(a);var s=URL.createObjectURL(i);window.location.assign(s)},storeMeasurements:async e=>{let{measurementData:t,dataSource:n,additionalFindingTypes:r,options:a={}}=e;if(z.info("[DICOMSR] storeMeasurements"),!n||!n.store||!n.store.dicom)return z.error("[DICOMSR] datasource has no dataSource.store.dicom endpoint!"),Promise.reject({});try{const e=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=H(e,t),o=Y.generateReport(r,c.metaData,c.utilities.worldToImageCoords,n),{dataset:a}=o;return void 0===a.SpecificCharacterSet&&(a.SpecificCharacterSet="ISO_IR 192"),a}(t,r,a),{StudyInstanceUID:i,ContentSequence:s}=e;if(!s?.[4].ContentSequence?.length)throw console.log("naturalizedReport missing imaging content",e),new Error("Invalid report, no content");return await n.store.dicom(e),i&&n.deleteStudyMetadataPromise(i),o.DicomMetadataStore.addInstances([e],!0),e}catch(e){throw console.warn(e),z.error(`[DICOMSR] Error while saving the measurements: ${e.message}`),new Error(e.message||"Error while saving the measurements.")}}},n={downloadReport:{commandFn:t.downloadReport,storeContexts:[],options:{}},storeMeasurements:{commandFn:t.storeMeasurements,storeContexts:[],options:{}}};return{actions:t,definitions:n,defaultContext:"CORNERSTONE_STRUCTURED_REPORT"}};function J(e,t,n){class r extends t{}r.toolName=e,(0,s.addTool)(r)}var K=d(414);const Z=o.classes.ImageSet,Q=(e,t)=>{const{displaySetInstanceUID:n,ReferencedSOPInstanceUID:r}=e,o=t.getDisplaySetByUID(n);if(o.images)return o.images.find((e=>e.SOPInstanceUID===r))},ee=(e,t)=>{const n=[],r={};for(const o of t.measurements){const{imageId:t}=o;if(!t)continue;if(r[t])continue;const a=Q(o,e);a?(r[t]=a,n.push(a)):console.log("Measurement",o,"had no instances found")}return n},te=(e,t)=>{const n=ee(e,t),r=new Z(n),o=n[0];return r.setAttributes({displaySetInstanceUID:r.uid,SeriesDate:o.SeriesDate,SeriesTime:o.SeriesTime,SeriesInstanceUID:r.uid,StudyInstanceUID:o.StudyInstanceUID,SeriesNumber:o.SeriesNumber||0,SOPClassUID:o.SOPClassUID,SeriesDescription:`${t.SeriesDescription} KO ${t.instance.SeriesNumber}`,Modality:"KO",isMultiFrame:!1,numImageFrames:n.length,SOPClassHandlerId:"@ohif/extension-default.sopClassHandlerModule.stack",isReconstructable:!1,isCompositeStack:!0,madeInClient:!0,excludeFromThumbnailBrowser:!0,updateInstances:function(){this.images.splice(0,this.images.length,...ee(e,t)),this.numImageFrames=this.images.length}}),e.addDisplaySets(r),r};function ne(){return ne=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},ne.apply(this,arguments)}const re=e.lazy((()=>Promise.resolve().then(d.bind(d,43)))),oe=t=>e.createElement(e.Suspense,{fallback:e.createElement("div",null,"Loading...")},e.createElement(re,t)),ae={id:t,onModeEnter:function(e){let{servicesManager:t}=e;const{displaySetService:n}=t.services;[...n.getDisplaySetCache().values()].filter((e=>e.SOPClassHandlerId===r)).forEach((e=>{e.isHydrated=!1}))},preRegistration:function(e){let{configuration:t={}}=e;(0,s.addTool)(p),J(S.SRLength,s.LengthTool),J(S.SRBidirectional,s.BidirectionalTool),J(S.SREllipticalROI,s.EllipticalROITool),J(S.SRCircleROI,s.CircleROITool),J(S.SRArrowAnnotate,s.ArrowAnnotateTool),J(S.SRAngle,s.AngleTool),J(S.SRCobbAngle,s.CobbAngleTool),J(S.SRPlanarFreehandROI,s.PlanarFreehandROITool);const n={lineDash:"4,4"};s.annotation.config.style.setToolGroupToolStyles("SRToolGroup",{SRLength:n,SRBidirectional:n,SREllipticalROI:n,SRCircleROI:n,SRArrowAnnotate:n,SRCobbAngle:n,SRAngle:n,SRPlanarFreehandROI:n,global:{}})},getViewportModule(t){let{servicesManager:n,extensionManager:r}=t;return[{name:"dicom-sr",component:t=>e.createElement(oe,ne({servicesManager:n,extensionManager:r},t))}]},getCommandsModule:X,getSopClassHandlerModule:V,getUtilityModule(e){let{servicesManager:t}=e;return[{name:"tools",exports:{toolNames:S}}]}}})(),f=d.O(f)})()));
//# sourceMappingURL=ohif-extension-cornerstone-dicom-sr.umd.js.map